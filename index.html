<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Excel Full Suite</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
<style>
    :root {
        --excel-green: #107C41;
        --ribbon-bg: #f3f3f3;
        --header-bg: #f8f9fa;
        --border-color: #d4d4d4;
        --select-border: #107C41;
        --select-bg: rgba(16, 124, 65, 0.1);
        --active-tab-bg: #fff;
        --inactive-tab-bg: #e1e1e1;
    }

    body {
        margin: 0; padding: 0;
        font-family: "Segoe UI", sans-serif;
        height: 100vh; display: flex; flex-direction: column;
        overflow: hidden; background: #fff;
        user-select: none; -webkit-user-select: none;
        overscroll-behavior: none; cursor: default;
    }

    /* --- Top Area --- */
    #title-bar {
        height: 28px; background: var(--excel-green); color: white;
        display: flex; align-items: center; padding: 0 15px; font-size: 12px;
        justify-content: space-between; flex-shrink: 0;
    }

    /* --- Ribbon Tabs --- */
    #ribbon-tabs {
        background: var(--excel-green); display: flex; padding-left: 10px; overflow-x: auto; flex-shrink: 0;
    }
    #ribbon-tabs::-webkit-scrollbar { display: none; }
    .r-tab {
        padding: 5px 15px; color: white; font-size: 12px; cursor: pointer;
        border-top-left-radius: 3px; border-top-right-radius: 3px; margin-right: 2px;
    }
    .r-tab:hover { background: rgba(255,255,255,0.2); }
    .r-tab.active {
        background: var(--ribbon-bg); color: var(--excel-green); font-weight: bold;
    }
    /* File tab is special */
    .r-tab[data-tab="file"] { background: #0b572e; font-weight: bold; }

    /* --- Ribbon Content --- */
    #ribbon-content {
        height: 90px; background: var(--ribbon-bg); border-bottom: 1px solid #ccc;
        position: relative; flex-shrink: 0;
    }
    .ribbon-panel {
        display: none; height: 100%; align-items: stretch; padding: 5px 0; overflow-x: auto;
        white-space: nowrap; scrollbar-width: none;
    }
    .ribbon-panel.active { display: flex; }
    .ribbon-panel::-webkit-scrollbar { display: none; }

    .rb-group {
        display: flex; align-items: flex-start; gap: 2px; padding: 0 8px;
        border-right: 1px solid #ccc; position: relative;
    }
    .rb-group::after {
        content: attr(data-label); position: absolute; bottom: 2px; left: 0; width: 100%;
        text-align: center; font-size: 10px; color: #888; pointer-events: none;
    }

    .rb-btn {
        min-width: 40px; height: 60px; border: 1px solid transparent; background: transparent;
        border-radius: 3px; cursor: pointer; display: flex; flex-direction: column;
        align-items: center; justify-content: flex-start; padding-top: 4px; color: #444;
    }
    .rb-btn:hover { background: #e1e1e1; }
    .rb-btn:active { background: #d0d0d0; }
    
    .rb-icon { font-size: 20px; height: 24px; display: flex; align-items: center; justify-content: center; }
    .rb-text { font-size: 10px; margin-top: auto; padding-bottom: 4px; line-height: 1.1; white-space: pre-wrap; text-align: center; }
    .rb-ind { width: 20px; height: 4px; margin-top: -4px; border: 1px solid #ccc; }

    /* --- Formula Bar --- */
    #formula-bar {
        height: 28px; border-bottom: 1px solid #ccc; display: flex; align-items: center;
        padding: 0 5px; background: #fff; flex-shrink: 0;
    }
    #name-box { width: 40px; text-align: center; border-right: 1px solid #ccc; font-size: 12px; color: #666; }
    #fx-input { flex: 1; border: none; outline: none; font-size: 13px; padding-left: 5px; }

    /* --- Grid --- */
    #sheet-wrapper {
        flex: 1; position: relative; overflow: hidden; background: #e6e6e6;
        display: flex; flex-direction: column;
    }
    #sheet-container {
        flex: 1; overflow: auto; position: relative;
    }
    #grid { display: grid; position: relative; background: #fff; transform-origin: top left; }

    /* View Options Classes */
    .no-gridlines .cell { border-right-color: transparent !important; border-bottom-color: transparent !important; }
    .no-headers .h-col, .no-headers .h-row { display: none !important; }
    
    .cell, .h-col, .h-row, .h-corner {
        box-sizing: border-box; border-right: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color); font-size: 13px;
        white-space: nowrap; overflow: hidden; display: flex; align-items: center; position: relative;
    }
    .h-col, .h-row, .h-corner { background: var(--header-bg); justify-content: center; position: sticky; z-index: 10; }
    .h-col { top: 0; border-top: 1px solid var(--border-color); }
    .h-row { left: 0; border-left: 1px solid var(--border-color); }
    .h-corner { top: 0; left: 0; z-index: 20; border-top: 1px solid var(--border-color); border-left: 1px solid var(--border-color); }

    .cell { background: #fff; padding: 0 4px; color: #000; }
    .cell.selected { background-color: var(--select-bg) !important; }
    .h-col.active-header, .h-row.active-header {
        background-color: #d3f0e0; color: var(--excel-green); font-weight: bold;
        border-bottom-color: var(--excel-green);
    }

    /* Resizers & Overlays */
    .resizer-col { position: absolute; right: 0; top: 0; width: 10px; height: 100%; cursor: col-resize; z-index: 15; }
    .resizer-row { position: absolute; bottom: 0; left: 0; width: 100%; height: 10px; cursor: row-resize; z-index: 15; }
    #overlay-layer { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 50; }
    #selection-border { position: absolute; border: 2px solid var(--select-border); display: none; }
    #fill-handle {
        position: absolute; width: 14px; height: 14px; background: var(--excel-green);
        border: 2px solid #fff; right: -8px; bottom: -8px; pointer-events: auto;
    }
    #resize-guide { position: absolute; background: var(--excel-green); display: none; z-index: 100; pointer-events: none; }
    #resize-tooltip { position: fixed; display: none; background: #fff; border: 1px solid #999; padding: 4px; font-size: 12px; z-index: 1000; }

    /* Images in Grid */
    .floating-img { position: absolute; border: 1px solid #ccc; resize: both; overflow: hidden; z-index: 5; }
    .floating-img img { width: 100%; height: 100%; object-fit: cover; }

    /* --- Tab Bar --- */
    #tab-bar {
        height: 32px; background: var(--ribbon-bg); border-top: 1px solid #ccc;
        display: flex; align-items: flex-end; padding-left: 5px; gap: 2px; overflow-x: auto; flex-shrink: 0;
    }
    .tab {
        height: 26px; padding: 0 15px; background: var(--inactive-tab-bg);
        border: 1px solid #bbb; border-bottom: none; border-radius: 4px 4px 0 0;
        display: flex; align-items: center; font-size: 12px; cursor: pointer; position: relative;
    }
    .tab.active {
        background: var(--active-tab-bg); height: 28px; color: var(--excel-green);
        font-weight: bold; border-bottom: 2px solid #fff; z-index: 10;
    }
    .tab-color-strip { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; }
    #add-sheet-btn { padding: 5px 10px; font-size: 18px; cursor: pointer; color: #444; }

    /* --- Menus --- */
    .popup-menu { position: fixed; display: none; background: #fff; border: 1px solid #999; box-shadow: 2px 2px 8px rgba(0,0,0,0.2); z-index: 2000; border-radius: 3px; padding: 5px; }
    .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; }
    .swatch { width: 20px; height: 20px; border: 1px solid #ccc; cursor: pointer; }
    .ctx-item { padding: 8px 16px; cursor: pointer; font-size: 12px; }
    .ctx-item:hover { background: #e6f3eb; }

    input[type="file"] { display: none; }
</style>
</head>
<body>

<div id="title-bar">
    <span id="file-name-display">Book1.xlsx</span>
    <span style="opacity:0.8; font-size:10px;" id="mode-display">Excel Mode</span>
</div>

<!-- Ribbon Tabs -->
<div id="ribbon-tabs">
    <div class="r-tab" data-tab="file">ãƒ•ã‚¡ã‚¤ãƒ«</div>
    <div class="r-tab active" data-tab="home">ãƒ›ãƒ¼ãƒ </div>
    <div class="r-tab" data-tab="insert">æŒ¿å…¥</div>
    <div class="r-tab" data-tab="layout">ãƒšãƒ¼ã‚¸ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</div>
    <div class="r-tab" data-tab="formula">æ•°å¼</div>
    <div class="r-tab" data-tab="data">ãƒ‡ãƒ¼ã‚¿</div>
    <div class="r-tab" data-tab="review">æ ¡é–²</div>
    <div class="r-tab" data-tab="view">è¡¨ç¤º</div>
</div>

<!-- Ribbon Content -->
<div id="ribbon-content">
    <!-- 1. FILE (Backstage mimic) -->
    <div class="ribbon-panel" id="tab-file">
        <div class="rb-group" data-label="ç®¡ç†">
            <button class="rb-btn" onclick="addNewSheet()"><span class="rb-icon">ğŸ“„</span><span class="rb-text">æ–°è¦</span></button>
            <button class="rb-btn" onclick="document.getElementById('file-input').click()"><span class="rb-icon">ğŸ“‚</span><span class="rb-text">é–‹ã</span></button>
            <button class="rb-btn" onclick="smartSave()"><span class="rb-icon">ğŸ’¾</span><span class="rb-text">ä¿å­˜</span></button>
            <button class="rb-btn" onclick="saveAsCSV()"><span class="rb-icon" style="border:1px solid #888; font-size:10px;">CSV</span><span class="rb-text">CSV<br>å‡ºåŠ›</span></button>
        </div>
        <div class="rb-group" data-label="å°åˆ·">
            <button class="rb-btn" onclick="window.print()"><span class="rb-icon">ğŸ–¨ï¸</span><span class="rb-text">å°åˆ·</span></button>
        </div>
    </div>

    <!-- 2. HOME -->
    <div class="ribbon-panel active" id="tab-home">
        <div class="rb-group" data-label="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰">
            <button class="rb-btn" onclick="copySel()"><span class="rb-icon">ğŸ“‹</span><span class="rb-text">ã‚³ãƒ”ãƒ¼</span></button>
            <button class="rb-btn" onclick="pasteSel()"><span class="rb-icon">ğŸ“Œ</span><span class="rb-text">è²¼ä»˜</span></button>
        </div>
        <div class="rb-group" data-label="ãƒ•ã‚©ãƒ³ãƒˆ">
            <button class="rb-btn" onclick="toggleStyle('bold')"><span class="rb-icon" style="font-weight:bold;">B</span><span class="rb-text">å¤ªå­—</span></button>
            <button class="rb-btn" onclick="toggleStyle('italic')"><span class="rb-icon" style="font-style:italic;">I</span><span class="rb-text">æ–œä½“</span></button>
            <button class="rb-btn" onclick="toggleStyle('underline')"><span class="rb-icon" style="text-decoration:underline;">U</span><span class="rb-text">ä¸‹ç·š</span></button>
            <button class="rb-btn" onclick="toggleBorder()"><span class="rb-icon" style="border:1px solid #444; width:14px; height:14px;"></span><span class="rb-text">ç½«ç·š</span></button>
            <button class="rb-btn" onclick="openColorPicker('bg',this)"><span class="rb-icon">ğŸª£</span><div class="rb-ind" id="bg-ind"></div><span class="rb-text">å¡—ã‚Š</span></button>
            <button class="rb-btn" onclick="openColorPicker('fg',this)"><span class="rb-icon" style="font-weight:bold;">A</span><div class="rb-ind" id="fg-ind" style="background:#000"></div><span class="rb-text">æ–‡å­—</span></button>
        </div>
        <div class="rb-group" data-label="é…ç½®">
            <button class="rb-btn" onclick="setAlign('top')"><span class="rb-icon">â¤’</span><span class="rb-text">ä¸Š</span></button>
            <button class="rb-btn" onclick="setAlign('middle')"><span class="rb-icon">â‡¯</span><span class="rb-text">ä¸­</span></button>
            <button class="rb-btn" onclick="setAlign('bottom')"><span class="rb-icon">â¤“</span><span class="rb-text">ä¸‹</span></button>
            <button class="rb-btn" onclick="setAlign('left')"><span class="rb-icon">â‡¤</span><span class="rb-text">å·¦</span></button>
            <button class="rb-btn" onclick="setAlign('center')"><span class="rb-icon">â†”</span><span class="rb-text">ä¸­å¤®</span></button>
            <button class="rb-btn" onclick="setAlign('right')"><span class="rb-icon">â‡¥</span><span class="rb-text">å³</span></button>
            <button class="rb-btn" onclick="toggleMerge()"><span class="rb-icon">â§‰</span><span class="rb-text">çµåˆ</span></button>
            <button class="rb-btn" onclick="toggleWrap()"><span class="rb-icon">â†µ</span><span class="rb-text">æŠ˜è¿”ã—</span></button>
        </div>
        <div class="rb-group" data-label="æ•°å€¤">
            <button class="rb-btn" onclick="setFormat('percent')"><span class="rb-icon">%</span><span class="rb-text">%</span></button>
            <button class="rb-btn" onclick="setFormat('comma')"><span class="rb-icon">,</span><span class="rb-text">æ¡</span></button>
        </div>
        <div class="rb-group" data-label="ç·¨é›†">
            <button class="rb-btn" onclick="insertRowCol()"><span class="rb-icon">â•</span><span class="rb-text">æŒ¿å…¥</span></button>
            <button class="rb-btn" onclick="deleteRowCol()"><span class="rb-icon">â–</span><span class="rb-text">å‰Šé™¤</span></button>
            <button class="rb-btn" onclick="notImpl('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼')"><span class="rb-icon">ğŸ”</span><span class="rb-text">æ¤œç´¢</span></button>
        </div>
    </div>

    <!-- 3. INSERT -->
    <div class="ribbon-panel" id="tab-insert">
        <div class="rb-group" data-label="ãƒ†ãƒ¼ãƒ–ãƒ«">
            <button class="rb-btn" onclick="notImpl('ãƒ”ãƒœãƒƒãƒˆãƒ†ãƒ¼ãƒ–ãƒ«')"><span class="rb-icon">ğŸ“Š</span><span class="rb-text">ãƒ”ãƒœãƒƒãƒˆ</span></button>
            <button class="rb-btn" onclick="notImpl('ãƒ†ãƒ¼ãƒ–ãƒ«')"><span class="rb-icon">â–¦</span><span class="rb-text">ãƒ†ãƒ¼ãƒ–ãƒ«</span></button>
        </div>
        <div class="rb-group" data-label="å›³">
            <button class="rb-btn" onclick="document.getElementById('img-input').click()"><span class="rb-icon">ğŸ–¼ï¸</span><span class="rb-text">ç”»åƒ</span></button>
            <button class="rb-btn" onclick="notImpl('å›³å½¢')"><span class="rb-icon">âšª</span><span class="rb-text">å›³å½¢</span></button>
        </div>
        <div class="rb-group" data-label="ã‚°ãƒ©ãƒ•">
            <button class="rb-btn" onclick="notImpl('ã‚°ãƒ©ãƒ•')"><span class="rb-icon">ğŸ“ˆ</span><span class="rb-text">æ£’</span></button>
            <button class="rb-btn" onclick="notImpl('ã‚°ãƒ©ãƒ•')"><span class="rb-icon">ğŸ“‰</span><span class="rb-text">æŠ˜ç·š</span></button>
            <button class="rb-btn" onclick="notImpl('ã‚°ãƒ©ãƒ•')"><span class="rb-icon">ğŸ•</span><span class="rb-text">å††</span></button>
        </div>
        <div class="rb-group" data-label="ãƒªãƒ³ã‚¯">
            <button class="rb-btn" onclick="insertLink()"><span class="rb-icon">ğŸ”—</span><span class="rb-text">ãƒªãƒ³ã‚¯</span></button>
        </div>
    </div>

    <!-- 4. PAGE LAYOUT -->
    <div class="ribbon-panel" id="tab-layout">
        <div class="rb-group" data-label="ãƒšãƒ¼ã‚¸è¨­å®š">
            <button class="rb-btn" onclick="notImpl('å°åˆ·ç¯„å›²')"><span class="rb-icon">ğŸ”²</span><span class="rb-text">ç¯„å›²</span></button>
            <button class="rb-btn" onclick="notImpl('ä½™ç™½')"><span class="rb-icon">â†”</span><span class="rb-text">ä½™ç™½</span></button>
            <button class="rb-btn" onclick="notImpl('å‘ã')"><span class="rb-icon">ğŸ”„</span><span class="rb-text">å‘ã</span></button>
            <button class="rb-btn" onclick="notImpl('ã‚µã‚¤ã‚º')"><span class="rb-icon">ğŸ“„</span><span class="rb-text">ã‚µã‚¤ã‚º</span></button>
        </div>
        <div class="rb-group" data-label="ã‚·ãƒ¼ãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³">
            <button class="rb-btn" onclick="toggleGridlines()"><span class="rb-icon">â–¦</span><span class="rb-text">ç›®ç››ç·š</span></button>
            <button class="rb-btn" onclick="toggleHeaders()"><span class="rb-icon">ğŸ” </span><span class="rb-text">è¦‹å‡ºã—</span></button>
        </div>
    </div>

    <!-- 5. FORMULAS -->
    <div class="ribbon-panel" id="tab-formula">
        <div class="rb-group" data-label="é–¢æ•°ãƒ©ã‚¤ãƒ–ãƒ©ãƒª">
            <button class="rb-btn" onclick="insertFunc('SUM')"><span class="rb-icon">Î£</span><span class="rb-text">SUM</span></button>
            <button class="rb-btn" onclick="insertFunc('AVERAGE')"><span class="rb-icon">xÌ„</span><span class="rb-text">å¹³å‡</span></button>
            <button class="rb-btn" onclick="insertFunc('COUNT')"><span class="rb-icon">ğŸ”¢</span><span class="rb-text">æ•°å€¤</span></button>
            <button class="rb-btn" onclick="insertFunc('MAX')"><span class="rb-icon">â¬†</span><span class="rb-text">æœ€å¤§</span></button>
            <button class="rb-btn" onclick="insertFunc('MIN')"><span class="rb-icon">â¬‡</span><span class="rb-text">æœ€å°</span></button>
            <button class="rb-btn" onclick="insertFunc('IF')"><span class="rb-icon">â“</span><span class="rb-text">è«–ç†</span></button>
            <button class="rb-btn" onclick="insertFunc('VLOOKUP')"><span class="rb-icon">ğŸ”</span><span class="rb-text">æ¤œç´¢</span></button>
        </div>
    </div>

    <!-- 6. DATA -->
    <div class="ribbon-panel" id="tab-data">
        <div class="rb-group" data-label="ä¸¦ã¹æ›¿ãˆã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼">
            <button class="rb-btn" onclick="notImpl('æ˜‡é †')"><span class="rb-icon">AZâ†“</span><span class="rb-text">æ˜‡é †</span></button>
            <button class="rb-btn" onclick="notImpl('é™é †')"><span class="rb-icon">ZAâ†“</span><span class="rb-text">é™é †</span></button>
            <button class="rb-btn" onclick="notImpl('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼')"><span class="rb-icon">ğŸ”»</span><span class="rb-text">çµè¾¼</span></button>
        </div>
        <div class="rb-group" data-label="ãƒ‡ãƒ¼ã‚¿ãƒ„ãƒ¼ãƒ«">
            <button class="rb-btn" onclick="notImpl('é‡è¤‡å‰Šé™¤')"><span class="rb-icon">âœ–</span><span class="rb-text">é‡è¤‡</span></button>
            <button class="rb-btn" onclick="notImpl('å…¥åŠ›è¦å‰‡')"><span class="rb-icon">âœ…</span><span class="rb-text">è¦å‰‡</span></button>
        </div>
    </div>

    <!-- 7. REVIEW -->
    <div class="ribbon-panel" id="tab-review">
        <div class="rb-group" data-label="æ–‡ç« æ ¡æ­£">
            <button class="rb-btn" onclick="notImpl('ã‚¹ãƒšãƒ«')"><span class="rb-icon">abc</span><span class="rb-text">ã‚¹ãƒšãƒ«</span></button>
        </div>
        <div class="rb-group" data-label="ã‚³ãƒ¡ãƒ³ãƒˆ">
            <button class="rb-btn" onclick="notImpl('ã‚³ãƒ¡ãƒ³ãƒˆ')"><span class="rb-icon">ğŸ’¬</span><span class="rb-text">ãƒ¡ãƒ¢</span></button>
        </div>
        <div class="rb-group" data-label="ä¿è­·">
            <button class="rb-btn" onclick="notImpl('ã‚·ãƒ¼ãƒˆä¿è­·')"><span class="rb-icon">ğŸ”’</span><span class="rb-text">ä¿è­·</span></button>
        </div>
    </div>

    <!-- 8. VIEW -->
    <div class="ribbon-panel" id="tab-view">
        <div class="rb-group" data-label="è¡¨ç¤º">
            <button class="rb-btn" onclick="toggleGridlines()"><span class="rb-icon">â–¦</span><span class="rb-text">ç›®ç››ç·š</span></button>
            <button class="rb-btn" onclick="toggleHeaders()"><span class="rb-icon">ğŸ” </span><span class="rb-text">è¦‹å‡ºã—</span></button>
            <button class="rb-btn" onclick="toggleFormulaBar()"><span class="rb-icon">Æ’x</span><span class="rb-text">æ•°å¼</span></button>
        </div>
        <div class="rb-group" data-label="ã‚ºãƒ¼ãƒ ">
            <button class="rb-btn" onclick="setZoom(1.2)"><span class="rb-icon">â•</span><span class="rb-text">æ‹¡å¤§</span></button>
            <button class="rb-btn" onclick="setZoom(1)"><span class="rb-icon">ğŸ’¯</span><span class="rb-text">100%</span></button>
            <button class="rb-btn" onclick="setZoom(0.8)"><span class="rb-icon">â–</span><span class="rb-text">ç¸®å°</span></button>
        </div>
    </div>
</div>

<!-- Formula Bar -->
<div id="formula-bar">
    <div id="name-box">A1</div>
    <input type="text" id="fx-input">
</div>

<!-- Grid -->
<div id="sheet-wrapper">
    <div id="sheet-container">
        <div id="grid"></div>
        <div id="overlay-layer">
            <div id="selection-border"><div id="fill-handle"></div></div>
            <div id="resize-guide"></div>
        </div>
    </div>
</div>
<div id="resize-tooltip"></div>

<!-- Tab Bar -->
<div id="tab-bar">
    <div id="add-sheet-btn" onclick="addNewSheet()">+</div>
</div>

<!-- Hidden -->
<input type="file" id="file-input" accept=".csv,.xlsx,.xlsm,.xls">
<input type="file" id="img-input" accept="image/*">
<div id="color-popup" class="popup-menu color-grid"></div>
<div id="ctx-menu" class="popup-menu">
    <div class="ctx-item" onclick="tabAction('rename')">åå‰å¤‰æ›´</div>
    <div class="ctx-item" onclick="tabAction('delete')">å‰Šé™¤</div>
</div>
<div id="af-menu" class="popup-menu">
    <div class="ctx-item" onclick="execAF('copy')">ã‚»ãƒ«ã®ã‚³ãƒ”ãƒ¼</div>
    <div class="ctx-item" onclick="execAF('series')">é€£ç¶šãƒ‡ãƒ¼ã‚¿</div>
</div>

<script>
    /* --- Core --- */
    const CONFIG = { rows: 100, cols: 26, colW: 80, rowH: 25 };
    const COLORS = ['#FFFFFF','#000000','#E7E6E6','#44546A','#5B9BD5','#ED7D31','#A5A5A5','#FFC000','#4472C4','#70AD47','#C00000','#FF0000','#FFFF00','#00B050','#0070C0','#7030A0'];
    
    let workbook = { Sheets: {}, SheetNames: [] };
    let activeSheetName = "";
    let currentFileName = "Book1", currentExt = "xlsx";
    
    let selStart = {r:0,c:0}, selEnd = {r:0,c:0};
    let currMode = 0; // IDLE
    let dragStart = {x:0,y:0};
    let resizeIdx = -1, resizeStartVal = 0;
    let fillTarget = null, ctxTabIdx = -1, colorType = 'bg';
    let currentZoom = 1;

    const grid = document.getElementById('grid');
    const container = document.getElementById('sheet-container');
    const resizeGuide = document.getElementById('resize-guide');
    const resizeTooltip = document.getElementById('resize-tooltip');

    /* --- Init --- */
    function init() {
        const n = "Sheet1";
        workbook.SheetNames.push(n); workbook.Sheets[n] = createEmptySheet(); activeSheetName = n;
        updateTitle(); renderTabs(); renderGrid();

        // Ribbon Logic
        document.querySelectorAll('.r-tab').forEach(t => {
            t.addEventListener('click', () => {
                document.querySelectorAll('.r-tab').forEach(x => x.classList.remove('active'));
                t.classList.add('active');
                document.querySelectorAll('.ribbon-panel').forEach(p => p.classList.remove('active'));
                document.getElementById('tab-' + t.dataset.tab).classList.add('active');
            });
        });

        // Event Bindings
        container.addEventListener('pointerdown', onDown);
        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', onUp);
        document.getElementById('fx-input').addEventListener('input', (e) => updateActiveCell(e.target.value));
        document.getElementById('file-input').addEventListener('change', fileOpen);
        document.getElementById('img-input').addEventListener('change', insertImage);

        const cp = document.getElementById('color-popup');
        COLORS.forEach(c => {
            const d = createEl('div','swatch',''); d.style.background=c; d.onclick=()=>applyColor(c); cp.appendChild(d);
        });
        window.onclick = (e) => {
            if(!e.target.closest('.rb-btn') && !e.target.closest('.popup-menu')) document.querySelectorAll('.popup-menu').forEach(el=>el.style.display='none');
        };
    }

    function createEmptySheet() {
        const ws = {};
        ws['!ref'] = XLSX.utils.encode_range({s:{c:0,r:0}, e:{c:CONFIG.cols-1, r:CONFIG.rows-1}});
        ws['!merges'] = [];
        return ws;
    }
    function updateTitle() { document.getElementById('file-name-display').textContent = `${currentFileName}.${currentExt}`; }

    /* --- File I/O --- */
    function smartSave() { (currentExt==='csv')?saveAsCSV():saveAsXLSX(); }
    function saveAsCSV() {
        const csv = XLSX.utils.sheet_to_csv(getActiveSheet());
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], {type:"text/csv"});
        downloadBlob(blob, `${currentFileName}.csv`);
    }
    function saveAsXLSX() {
        const wbOut = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbOut], {type:"application/octet-stream"});
        downloadBlob(blob, `${currentFileName}.xlsx`);
    }
    function downloadBlob(b,n) { const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=n; a.click(); }
    function fileOpen(e) {
        const f = e.target.files[0]; if(!f)return;
        const parts = f.name.split('.');
        currentExt = (parts.length>1) ? parts.pop().toLowerCase() : 'xlsx';
        currentFileName = parts.join('.');
        if(currentExt==='xlsm'||currentExt==='xls') currentExt='xlsx';
        const r = new FileReader();
        r.onload = (evt) => {
            workbook = XLSX.read(new Uint8Array(evt.target.result), {type:'array', cellStyles:true});
            activeSheetName = workbook.SheetNames[0];
            updateTitle(); renderTabs(); renderGrid();
        };
        r.readAsArrayBuffer(f);
    }

    /* --- Grid Render --- */
    function getActiveSheet() { return workbook.Sheets[activeSheetName]; }
    function renderGrid() {
        const ws = getActiveSheet(); grid.innerHTML = '';
        
        let tpl="40px"; const colW=ws['!cols']||[];
        for(let c=0; c<CONFIG.cols; c++) tpl+=` ${(colW[c]&&colW[c].wpx)?colW[c].wpx:CONFIG.colW}px`;
        grid.style.gridTemplateColumns=tpl;

        const corner=createEl('div','h-corner',''); corner.onclick=selectAll; grid.appendChild(corner);
        for(let c=0; c<CONFIG.cols; c++) {
            const h=createEl('div','h-col',getColName(c)); h.dataset.c=c; h.onclick=()=>selectCol(c);
            h.appendChild(createEl('div','resizer-col','')); h.lastChild.dataset.c=c; grid.appendChild(h);
        }
        const rowH=ws['!rows']||[];
        for(let r=0; r<CONFIG.rows; r++) {
            const rPx=(rowH[r]&&rowH[r].hpx)?rowH[r].hpx:CONFIG.rowH;
            const h=createEl('div','h-row',r+1); h.style.height=rPx+'px'; h.dataset.r=r; h.onclick=()=>selectRow(r);
            h.appendChild(createEl('div','resizer-row','')); h.lastChild.dataset.r=r; grid.appendChild(h);
            for(let c=0; c<CONFIG.cols; c++) {
                const cell=createEl('div','cell',''); cell.id=`c-${r}-${c}`; cell.dataset.r=r; cell.dataset.c=c; cell.style.height=rPx+'px'; grid.appendChild(cell);
            }
        }
        // Merges
        (ws['!merges']||[]).forEach(m => {
            for(let r=m.s.r; r<=m.e.r; r++) for(let c=m.s.c; c<=m.e.c; c++) {
                if(r===m.s.r && c===m.s.c) {
                    const cell=document.getElementById(`c-${r}-${c}`);
                    cell.style.gridColumnStart=m.s.c+2; cell.style.gridColumnEnd=m.e.c+3;
                    cell.style.gridRowStart=m.s.r+2; cell.style.gridRowEnd=m.e.r+3; cell.style.zIndex=1;
                } else document.getElementById(`c-${r}-${c}`).style.display='none';
            }
        });
        // Data & Style
        for(const ref in ws) {
            if(ref[0]==='!') continue;
            const pos = XLSX.utils.decode_cell(ref);
            const cell = document.getElementById(`c-${pos.r}-${pos.c}`);
            if(!cell) continue;
            const obj = ws[ref];
            cell.textContent = obj.w || obj.v || "";
            if(obj.s) {
                const s = obj.s;
                if(s.font) {
                    if(s.font.bold) cell.style.fontWeight='bold';
                    if(s.font.italic) cell.style.fontStyle='italic';
                    if(s.font.underline) cell.style.textDecoration='underline';
                    if(s.font.color && s.font.color.rgb) cell.style.color='#'+s.font.color.rgb;
                }
                if(s.fill?.fgColor?.rgb) cell.style.backgroundColor='#'+s.fill.fgColor.rgb;
                if(s.alignment) {
                    const h=s.alignment.horizontal, v=s.alignment.vertical;
                    cell.style.justifyContent = h==='center'?'center':h==='right'?'flex-end':'flex-start';
                    cell.style.alignItems = v==='top'?'flex-start':v==='center'?'center':'flex-end';
                    if(s.alignment.wrapText) cell.style.whiteSpace='normal';
                }
                if(s.border?.top) cell.style.border='1px solid #000';
            }
        }
        updateSelection();
    }
    
    function createEl(t,c,x){const d=document.createElement(t);d.className=c;d.textContent=x;return d;}
    function getColName(n){let s="";while(n>=0){s=String.fromCharCode(n%26+65)+s;n=Math.floor(n/26)-1;}return s;}

    /* --- Logic --- */
    function updateActiveCell(v) { setCell(selStart.r,selStart.c,{v}); renderGrid(); }
    function setCell(r,c,o) {
        const ws=getActiveSheet(), ref=XLSX.utils.encode_cell({r,c});
        if(!ws[ref]) ws[ref]={t:'s',v:''};
        Object.assign(ws[ref], o);
        if(!isNaN(Number(o.v)) && o.v!=="") ws[ref].t='n'; else ws[ref].t='s';
    }
    function selectRange(r1,c1,r2,c2){ selStart={r:r1,c:c1}; selEnd={r:r2,c:c2}; updateSelection(); }
    function selectAll(){ selectRange(0,0,CONFIG.rows-1,CONFIG.cols-1); }
    function selectCol(c){ selectRange(0,c,CONFIG.rows-1,c); }
    function selectRow(r){ selectRange(r,0,r,CONFIG.cols-1); }
    function getSelectedRange(){ return {r1:Math.min(selStart.r,selEnd.r),r2:Math.max(selStart.r,selEnd.r),c1:Math.min(selStart.c,selEnd.c),c2:Math.max(selStart.c,selEnd.c)}; }

    function updateSelection() {
        document.querySelectorAll('.selected, .active-header').forEach(e=>e.classList.remove('selected','active-header'));
        const {r1,r2,c1,c2} = getSelectedRange();
        for(let c=c1;c<=c2;c++) grid.querySelector(`.h-col[data-c="${c}"]`)?.classList.add('active-header');
        for(let r=r1;r<=r2;r++) grid.querySelector(`.h-row[data-r="${r}"]`)?.classList.add('active-header');
        for(let r=r1;r<=r2;r++) for(let c=c1;c<=c2;c++) {
            const el=document.getElementById(`c-${r}-${c}`);
            if(el&&(r!==selStart.r||c!==selStart.c)) el.classList.add('selected');
        }
        const s=document.getElementById(`c-${r1}-${c1}`), e=document.getElementById(`c-${r2}-${c2}`), b=document.getElementById('selection-border');
        if(s&&e){ b.style.display='block'; b.style.top=s.offsetTop+'px'; b.style.left=s.offsetLeft+'px'; b.style.width=(e.offsetLeft+e.offsetWidth-s.offsetLeft)+'px'; b.style.height=(e.offsetTop+e.offsetHeight-s.offsetTop)+'px';
            document.getElementById('name-box').textContent=getColName(selStart.c)+(selStart.r+1);
            const ref=XLSX.utils.encode_cell(selStart), ws=getActiveSheet();
            document.getElementById('fx-input').value = (ws[ref]?ws[ref].v:"");
        }
    }

    /* --- Events --- */
    function onDown(e) {
        if(e.target.closest('.popup-menu'))return; dragStart={x:e.clientX,y:e.clientY}; const t=e.target;
        if(t.classList.contains('resizer-col')){currMode=3;resizeIdx=parseInt(t.dataset.c);resizeStartVal=t.parentElement.offsetWidth;t.setPointerCapture(e.pointerId);return;}
        if(t.classList.contains('resizer-row')){currMode=4;resizeIdx=parseInt(t.dataset.r);resizeStartVal=t.parentElement.offsetHeight;t.setPointerCapture(e.pointerId);return;}
        if(t.id==='fill-handle'){currMode=2;fillTarget=null;t.setPointerCapture(e.pointerId);e.preventDefault();return;}
        const cell=t.closest('.cell');
        if(cell) {
            currMode=1; const r=parseInt(cell.dataset.r), c=parseInt(cell.dataset.c);
            selStart={r,c}; selEnd={r,c}; updateSelection(); 
            // Only prevent default if we are selecting to stop scrolling on drag, otherwise allow scroll
            // Actually, for better UX: prevent default to stop scroll ONLY if drag starts
        }
    }
    function onMove(e) {
        if(currMode===0)return; 
        if(currMode===1) e.preventDefault(); // Stop scroll when selecting
        if(currMode===3){const w=Math.max(10,resizeStartVal+(e.clientX-dragStart.x));showGuide(true,e.clientX,0);showTooltip(e.clientX,e.clientY,`å¹…: ${w}px`);}
        else if(currMode===4){const h=Math.max(10,resizeStartVal+(e.clientY-dragStart.y));showGuide(false,0,e.clientY);showTooltip(e.clientX,e.clientY,`é«˜ã•: ${h}px`);}
        else if(currMode===1){
            const el=document.elementFromPoint(e.clientX,e.clientY); const c=el?.closest('.cell');
            if(c){const r=parseInt(c.dataset.r),col=parseInt(c.dataset.c); if(r!==selEnd.r||col!==selEnd.c){selEnd={r,c:col};updateSelection();}}
        }
    }
    function onUp(e) {
        const ws=getActiveSheet();
        if(currMode===3){
            const w=Math.max(10,resizeStartVal+(e.clientX-dragStart.x));
            if(!ws['!cols']) ws['!cols']=[]; ws['!cols'][resizeIdx]={wpx:w}; renderGrid();
        }
        else if(currMode===4){
            const h=Math.max(10,resizeStartVal+(e.clientY-dragStart.y));
            if(!ws['!rows']) ws['!rows']=[]; ws['!rows'][resizeIdx]={hpx:h}; renderGrid();
        }
        else if(currMode===2 && fillTarget) { /* AutoFill Logic here if needed */ }
        currMode=0; resizeGuide.style.display='none'; resizeTooltip.style.display='none';
        if(e.target.releasePointerCapture)try{e.target.releasePointerCapture(e.pointerId);}catch(z){}
    }
    function showGuide(isCol,x,y){resizeGuide.style.display='block';if(isCol){resizeGuide.style.top='0';resizeGuide.style.left=(x-container.getBoundingClientRect().left+container.scrollLeft)+'px';resizeGuide.style.width='2px';resizeGuide.style.height=container.scrollHeight+'px';}else{resizeGuide.style.left='0';resizeGuide.style.top=(y-container.getBoundingClientRect().top+container.scrollTop)+'px';resizeGuide.style.height='2px';resizeGuide.style.width=container.scrollWidth+'px';}}
    function showTooltip(x,y,t){resizeTooltip.style.display='block';resizeTooltip.style.left=(x+15)+'px';resizeTooltip.style.top=(y+15)+'px';resizeTooltip.textContent=t;}

    /* --- Styles --- */
    function applyStyle(prop, val) {
        const {r1,r2,c1,c2} = getSelectedRange(); const ws = getActiveSheet();
        for(let r=r1;r<=r2;r++) for(let c=c1;c<=c2;c++) {
            const ref = XLSX.utils.encode_cell({r,c});
            if(!ws[ref]) ws[ref]={t:'s',v:'',s:{}}; if(!ws[ref].s) ws[ref].s={};
            if(prop==='bold'){if(!ws[ref].s.font)ws[ref].s.font={}; ws[ref].s.font.bold=val;}
            if(prop==='italic'){if(!ws[ref].s.font)ws[ref].s.font={}; ws[ref].s.font.italic=val;}
            if(prop==='underline'){if(!ws[ref].s.font)ws[ref].s.font={}; ws[ref].s.font.underline=val;}
            if(prop==='bg'){if(!ws[ref].s.fill)ws[ref].s.fill={}; ws[ref].s.fill.fgColor={rgb:val.replace('#','')};}
            if(prop==='color'){if(!ws[ref].s.font)ws[ref].s.font={}; ws[ref].s.font.color={rgb:val.replace('#','')};}
            if(prop==='alignH'){if(!ws[ref].s.alignment)ws[ref].s.alignment={}; ws[ref].s.alignment.horizontal=val;}
            if(prop==='alignV'){if(!ws[ref].s.alignment)ws[ref].s.alignment={}; ws[ref].s.alignment.vertical=val;}
            if(prop==='wrap'){if(!ws[ref].s.alignment)ws[ref].s.alignment={}; ws[ref].s.alignment.wrapText=val;}
            if(prop==='border'){if(!val)delete ws[ref].s.border; else ws[ref].s.border={top:{style:'thin'},bottom:{style:'thin'},left:{style:'thin'},right:{style:'thin'}};}
        }
        renderGrid();
    }
    
    function toggleStyle(k) { applyStyle(k, true); } // Toggle logic simplified
    function setAlign(a) { ['left','center','right'].includes(a) ? applyStyle('alignH',a) : applyStyle('alignV',a); }
    function toggleWrap() { applyStyle('wrap', true); }
    function toggleBorder() { applyStyle('border', true); }
    function openColorPicker(t,b){colorType=t;const p=document.getElementById('color-popup');p.style.display='grid';const r=b.getBoundingClientRect();p.style.top=(r.bottom+5)+'px';p.style.left=r.left+'px';}
    function applyColor(c){document.getElementById('color-popup').style.display='none';applyStyle(colorType==='bg'?'bg':'color', c);document.getElementById(colorType==='bg'?'bg-ind':'fg-ind').style.background=c;}
    
    function toggleMerge() {
        const ws=getActiveSheet(); if(!ws['!merges'])ws['!merges']=[];
        const {r1,r2,c1,c2}=getSelectedRange();
        // Remove existing merges in range
        ws['!merges'] = ws['!merges'].filter(m => !(m.s.r>=r1 && m.e.r<=r2 && m.s.c>=c1 && m.e.c<=c2));
        ws['!merges'].push({s:{r:r1,c:c1},e:{r:r2,c:c2}});
        renderGrid();
    }

    /* --- View --- */
    function toggleGridlines() { grid.classList.toggle('no-gridlines'); }
    function toggleHeaders() { grid.classList.toggle('no-headers'); }
    function toggleFormulaBar() { const b=document.getElementById('formula-bar'); b.style.display=b.style.display==='none'?'flex':'none'; }
    function setZoom(z) { currentZoom=z; grid.style.transform=`scale(${z})`; }

    /* --- Insert --- */
    function insertImage(e) {
        const f=e.target.files[0]; if(!f)return;
        const reader=new FileReader();
        reader.onload=(evt)=>{
            const div=document.createElement('div'); div.className='floating-img';
            div.style.left='50px'; div.style.top='50px'; div.style.width='100px'; div.style.height='100px';
            const img=document.createElement('img'); img.src=evt.target.result;
            div.appendChild(img); grid.appendChild(div);
            // Drag logic for image omitted for brevity
        };
        reader.readAsDataURL(f);
    }
    function insertLink() { const url=prompt("URL:"); if(url) updateActiveCell(url); /* logic to make clickable */ }
    function insertFunc(fn) { updateActiveCell(`=${fn}()`); }

    /* --- Tab --- */
    function renderTabs() {
        const add=document.getElementById('add-sheet-btn');
        Array.from(document.getElementById('tab-bar').children).forEach(c=>c!==add && c.remove());
        workbook.SheetNames.forEach((n,i)=>{
            const t=createEl('div',`tab ${n===activeSheetName?'active':''}`, n);
            t.onclick=()=>{activeSheetName=n; renderGrid();};
            t.oncontextmenu=(e)=>{e.preventDefault(); ctxTabIdx=i; const m=document.getElementById('ctx-menu'); m.style.display='block'; m.style.left=e.clientX+'px'; m.style.top=(e.clientY-m.offsetHeight)+'px';};
            document.getElementById('tab-bar').insertBefore(t,add);
        });
    }
    function addNewSheet() {
        const n="Sheet"+(workbook.SheetNames.length+1);
        workbook.SheetNames.push(n); workbook.Sheets[n]=createEmptySheet();
        activeSheetName=n; renderTabs(); renderGrid();
    }
    function tabAction(a) {
        document.getElementById('ctx-menu').style.display='none';
        const oldName=workbook.SheetNames[ctxTabIdx];
        if(a==='rename'){const n=prompt("åå‰:",oldName); if(n){workbook.SheetNames[ctxTabIdx]=n; workbook.Sheets[n]=workbook.Sheets[oldName]; delete workbook.Sheets[oldName]; if(activeSheetName===oldName)activeSheetName=n; renderTabs();}}
        if(a==='delete'){if(workbook.SheetNames.length>1 && confirm("å‰Šé™¤?")){workbook.SheetNames.splice(ctxTabIdx,1); delete workbook.Sheets[oldName]; activeSheetName=workbook.SheetNames[0]; renderTabs(); renderGrid();}}
    }

    /* --- Utils --- */
    function copySel(){
        const {r1,r2,c1,c2} = getSelectedRange(); const ws = getActiveSheet(); let txt = "";
        for(let r=r1; r<=r2; r++) {
            let row = [];
            for(let c=c1; c<=c2; c++) { const ref = XLSX.utils.encode_cell({r,c}); row.push(ws[ref]?ws[ref].v:""); }
            txt += row.join("\t") + "\n";
        }
        navigator.clipboard.writeText(txt);
    }
    async function pasteSel(){
        try {
            const txt = await navigator.clipboard.readText();
            const rows = txt.trim().split("\n");
            rows.forEach((r,i)=>{ const cols=r.split("\t"); cols.forEach((v,j)=>setCell(selStart.r+i,selStart.c+j,{v})); });
            renderGrid();
        } catch(e){}
    }
    function notImpl(f) { alert(`æ©Ÿèƒ½ã€Œ${f}ã€ã¯ã€Webãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆã§ã¯ç¾åœ¨ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚`); }
    function undo(){} function redo(){} // Placeholders

    init();
</script>
</body>
</html>
